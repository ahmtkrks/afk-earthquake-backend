(()=>{"use strict";var e={37:function(e,t,n){var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),o(n(109),t)},109:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.serviceAccountKey=void 0,t.serviceAccountKey={type:"service_account",project_id:"earthquake-3166c",private_key_id:"424257f889fd42005a7719111b9cfa8591881994",private_key:"-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC01m2ZdSbhbGSn\nbjVJomEpNBwMXEVIgWICJljyiYkt6CUs+1X/jSDmSDnT5VmGAXubKLoI+WoiqxmN\nWFoXMnTqAnzUVP50Fbq80nkRw/WzUYBU4LJ/9QL20jbXrjXUdX0htewYnJ9qCpL0\nA1O/jwPH4OU5zsEwCIEnVPkAegx8BcSJ5dqyQq4UgAo2ICeth10J73NU6sv5U6kj\nhk/GGTSBVCv/s6c0XinEhV3QAmcLBSKavpHWKId/YH9MQkDXxS6ShC6TSVHpxXii\n3H9e7n+BxZr7W46LDqhiS6KMqvqkU6ZwIgg6zY0upug7FvHQ+pdOGQk4E9fW+DzC\n2s4P7HI3AgMBAAECggEAUgYIxFhNAGaH6SGl7fZHF8dZCYo4qsB00gDOy4Pywu3P\nHu4JfdZnm8wa3q/iwVOe2yvH5hYrO/pbpq7yfh8WxKXINQ8wMzs/7jGRVKuLoIBR\nMy6QCFX7uDR1R7LvG6UG0umPY0J3VEPjj+aKcBLQZjLuBiBvo/fXjR2Pq9WwH/hA\nANtSYfci+vJ84N1J7kvKulPy45Oec2xsf/p9zde8BmHwNPINtC7pxd3+FZTrTGA2\nc0OGb4LALZH7KkfnW5QEoh1qkmPQMXWN4NvaGxWYtIu9ldIz+j0zIiILE5iAMujM\n5NRwWpl/SsdHaB74tfWbRjsmnT8edHTI4+bx79v5IQKBgQD9C0O2sTRlMySUY8Rt\nXRHxYipmika6lSCRp2UWCUf0lI6tx/A6AjdyHEUa+mkrpx7m/hUsdrc0oREckQka\n2Cqdga8vDI/SqRD1AKgr4EupV/N2YWCfRFlQKP2EwydsxHXixUAxrNzOjCFqGNhF\n/ZSegPRfd7yjeCk82VWU7xk+yQKBgQC28zpxDZlXy6jdxiUjXe4ic9D+MJFqBFua\nawj53kDLF/gyAuaXoj1VNykPj++ngt9NPJHAA4IRboZtWzUja1hbGhS0J+LUYUK4\nmAKXm4GLYCifmgihJPlDoTUP8TOaLW8490sipBvkRFGPkdGIbCeyUnzTSsoOf5wO\nh4jb2nuo/wKBgEqWpXEWrvEdsCylc+Mgygcy/niXTd3101Hb2+ow9ircF2qWQvN2\nb82NE7muEo4xhuRkBO3EWKCE0bxv7BUjnvwqm+7sbwCToVH2zZuRU/wo1rUQYyDP\nTtxYGNKni9l915nutsttvvCLUdYqWKXY55QJQv9ZFhvBcbZkAdwS1ogxAoGAcoMp\n+Gt3qPGMIEyPIGUB0kTF8uT5j+9sWupWMvg/fB/jtYIFTbI6S6V8KQaCDkqndNPN\nsu8/MaQJtldZmnLtWhCoFt/EZgT+20YikTy/yDqHEuc6MYtQDlnQOctS7lU0Aecf\n+23XG3j7yC6QhaCU9FQXV7W/ZXXQe3OwYVSPBIcCgYEA9GhPZ6LrE2xUWo6gAWt+\nGZcQ8ORQWrT2XUK2SraiWtaXYJPdc89diSGTNk+jQQwHtPdaGGo8rSHUkNHtOoDA\nHzhjPeBapNGPJPX7jy7b0+6bW7s4seqKg7zz6DAs3xZW5qDHac8m8A6GGbJPhyLd\nInGXIlOTBDKrDvOo/RKqw+I=\n-----END PRIVATE KEY-----\n",client_email:"firebase-adminsdk-z5icr@earthquake-3166c.iam.gserviceaccount.com",client_id:"111209414108028871233",auth_uri:"https://accounts.google.com/o/oauth2/auth",token_uri:"https://oauth2.googleapis.com/token",auth_provider_x509_cert_url:"https://www.googleapis.com/oauth2/v1/certs",client_x509_cert_url:"https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-z5icr%40earthquake-3166c.iam.gserviceaccount.com",universe_domain:"googleapis.com"}},728:function(e,t,n){var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},r.apply(this,arguments)},o=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))},i=this&&this.__generator||function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(s=0)),s;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),n(142).config();var a=n(37),c=s(n(860)),u=n(581),l=s(n(509)),f=(0,c.default)(),d=process.env.PORT,p=void 0===d?4e3:d;l.default.initializeApp({credential:l.default.credential.cert(a.serviceAccountKey)});var h=[],v=new Date;f.use(c.default.json()),f.post("/save",(function(e,t){return o(void 0,void 0,void 0,(function(){var n,r;return i(this,(function(o){switch(o.label){case 0:return n=e.body.token,h.push("Saving token ".concat(n,".")),[4,u.DB.saveToken(n)];case 1:return r=o.sent(),t.send({result:r,logs:h}),[2]}}))}))})),f.get("/tokens",(function(e,t){return o(void 0,void 0,void 0,(function(){var e,n,o,s,a,c,f,d,p,g;return i(this,(function(i){switch(i.label){case 0:return e=new Date,(n=e.getTime()-v.getTime())<3e4?(console.log("Too many requests. ".concat(n,"ms since last request.")),h.push("Too many requests. ".concat(n,"ms since last request.")),[2,t.send({message:"Too many requests. ".concat(n,"ms since last request."),logs:h})]):(v=e,console.log("Tokens requested."),h.push("Tokens requested. ".concat((new Date).toISOString())),[4,u.DB.getTokens()]);case 1:o=i.sent(),s={notification:{title:"Deprem Uyarısı!",body:"Yakınlarda deprem oluyor, dikkatli olun!"}},a=o.map((function(e){return r(r({},s),{token:e.token})})),c=0,f=a,i.label=2;case 2:if(!(c<f.length))return[3,7];d=f[c],i.label=3;case 3:return i.trys.push([3,5,,6]),[4,l.default.messaging().send(d)];case 4:return p=i.sent(),console.log(p),[3,6];case 5:return g=i.sent(),console.log("Sending notif error: ".concat(g.message)),[3,6];case 6:return c++,[3,2];case 7:return t.send({tokens:o,logs:h}),[2]}}))}))})),f.get("/reset",(function(e,t){return o(void 0,void 0,void 0,(function(){return i(this,(function(e){return console.log("Resettings logs"),h.length=0,t.send({logs:h}),[2]}))}))})),f.listen(p,(function(){console.log("⚡ Server Started at ::".concat(p," ").concat((new Date).toISOString()))})),t.default=f},581:function(e,t,n){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(c){return function(a){if(n)throw new TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(s=0)),s;)try{if(n=1,r&&(o=2&a[0]?r.return:a[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,a[1])).done)return o;switch(r=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,r=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],r=0}finally{n=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.DB=void 0;var i=new(n(900).Pool)({host:process.env.DB_HOST,port:5432,database:process.env.DB_NAME,user:process.env.DB_USER,password:process.env.DB_PASSWORD}),s=function(){function e(){}return e.saveToken=function(e){return r(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,i.query("SELECT * FROM user_devices WHERE token = $1",[e])];case 1:return n.sent().rows.length>0?[2,[]]:(t=[e],[4,i.query("INSERT INTO user_devices (token) VALUES ($1) RETURNING *",t)]);case 2:return[2,n.sent().rows[0]]}}))}))},e.getTokens=function(){return r(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,i.query("SELECT * FROM user_devices")];case 1:return[2,e.sent().rows]}}))}))},e}();t.DB=s},142:e=>{e.exports=require("dotenv")},860:e=>{e.exports=require("express")},509:e=>{e.exports=require("firebase-admin")},900:e=>{e.exports=require("pg")}},t={};!function n(r){var o=t[r];if(void 0!==o)return o.exports;var i=t[r]={exports:{}};return e[r].call(i.exports,i,i.exports,n),i.exports}(728)})();